/*
* This Source Code Form is subject to the terms of the Mozilla Public
* License, v. 2.0. If a copy of the MPL was not distributed with this
* file, You can obtain one at https://mozilla.org/MPL/2.0/.
*
* Copyright (c) 2025 Florian K.
*
*/

using Avalonia;
using Avalonia.Controls;
using BlackSharp.Core.Extensions;
using BlackSharp.Core.Logging;
using BlackSharp.MVVM.Dialogs.Enums;
using LibreDiagnostics.Language.Resources;
using LibreDiagnostics.Models.Configuration;
using LibreDiagnostics.Models.Globals;
using LibreDiagnostics.Models.Logging;
using LibreDiagnostics.MVVM.Utilities;
using LibreDiagnostics.Tasks.Github;
using System.Diagnostics;
using System.Reflection;
using LDUpdater = LibreDiagnostics.Tasks.Github.Updater;
using OS = BlackSharp.Core.Platform.OperatingSystem;

namespace LibreDiagnostics.UI
{
    /// <summary>
    /// Provides the entry point and core startup logic for the application.
    /// </summary>
    public static class Client
    {
        #region Fields

        const int UpdateConfirmationTimeoutSeconds = 30;
        const string UpdaterWindows = $"{nameof(LibreDiagnostics)}.Updater.exe";
        const string UpdaterLinux = $"{nameof(LibreDiagnostics)}.Updater";

        #endregion

        #region Public

        /// <summary>
        /// Initializes and starts the application using the specified command-line arguments.
        /// </summary>
        /// <param name="args">A list of command-line arguments to configure the applications startup behavior. Cannot be null.</param>
        public static void Start(IList<string> args)
        {
            //Handle exceptions if not debugging
            if (!Debugger.IsAttached)
            {
                AppDomain.CurrentDomain.UnhandledException += OnUnhandledExceptionAppDomain;
            }

            //Enable logging
            Logger.Instance.IsEnabled = true;
            Logger.Instance.LogLevel = LogLevel.Info;
            LoggerUtilities.SetLogFilePath(DateTime.Now);

            //Construct version information
            var assembly = Assembly.GetEntryAssembly();
            var version = assembly?.GetName().Version;
            var versionalInformation = assembly?.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion;

            var detailedVersion = $"v{version.ToString(3)}";

            if (!string.IsNullOrWhiteSpace(versionalInformation))
            {
                detailedVersion += $" ({versionalInformation})";
            }

            //Log version
            Logger.Instance.Add(LogLevel.Info, $"Starting {Resources.AppName} {detailedVersion}", DateTime.Now);

            //Reload settings
            Global.Settings = Settings.Reload();

            if (!Design.IsDesignMode)
            {
                if (Global.Settings.AutoUpdate)
                {
                    //Wait for the update
                    TryUpdate(false).Wait();
                }
            }

            //Set icon paths for hardware monitors
            SetIconData();

            //This blocks until app shuts down
            StartApp(args);

            //Save log on exit
            Logger.Instance.Add(LogLevel.Info, $"Exiting {Resources.AppName} {detailedVersion}", DateTime.Now);
            Logger.Instance.Add(LogLevel.Info, string.Empty, DateTime.Now);
            LoggerUtilities.SaveLogFile();
        }

        #endregion

        #region Internal

        internal static async Task TryUpdate(bool askForConfirmation)
        {
            try
            {
                //Prevent updates while debugging
                if (Debugger.IsAttached)
                {
                    Debug.WriteLine($"{nameof(TryUpdate)} was called. Not executing update as debugger is attached. Please do manually or disable.");
                }
                else
                {
                    //Create updater
                    var updater = new Updater(Constants.Owner, Constants.Repository);

                    //Get running version
                    var version = Assembly.GetEntryAssembly()?.GetName().Version;

                    //Check if an update is available
                    if (version != null)
                    {
                        var updateCheckResult = await updater.IsUpdateAvailable(version);

                        if (updateCheckResult.IsUpdateAvailable)
                        {
                            //Ask user for confirmation if needed
                            if (askForConfirmation)
                            {
                                //Format message to include release notes
                                var message = string.Format(Resources.UpdateAvailableMessage.Replace(@"\n", Environment.NewLine), updateCheckResult.ReleaseNotes);

                                //Ask user for confirmation with a timeout
                                var result = MessageBro.DoShowMessageTimeout(Resources.UpdateAvailableTitle, message, DialogButtons.YesNo, TimeSpan.FromSeconds(UpdateConfirmationTimeoutSeconds), out var timeouted);

                                //If user declined or timeouted, abort update
                                if (timeouted || result == DialogButtonType.No)
                                {
                                    return;
                                }
                            }

                            //Construct arguments
                            List<string> args = [$"{LDUpdater.CallingApplicationArg}=\"{Environment.ProcessPath}\"", LDUpdater.StartUpdateArg];

                            //Start updater
                            if (OS.IsWindows())
                            {
                                Process.Start(new ProcessStartInfo(UpdaterWindows, args)
                                {
                                    CreateNoWindow = true,
                                });
                            }
                            else if (OS.IsLinux())
                            {
                                Process.Start(new ProcessStartInfo(UpdaterLinux, args)
                                {
                                    CreateNoWindow = true,
                                });
                            }
                            else
                            {
                                Logger.Instance.Add(LogLevel.Warn, $"{nameof(TryUpdate)}: OS unsupported", DateTime.Now);
                            }

                            Environment.Exit(666);
                        }
                    }
                }
            }
            catch (Exception e)
            {
                //Log any errors
                Logger.Instance.Add(LogLevel.Error, $"Update failed: {e.FullExceptionString()}", DateTime.Now);
            }
        }

        #endregion

        #region Private

        [STAThread]
        static void StartApp(IList<string> args)
        {
            // Initialization code. Don't use any Avalonia, third-party APIs or any
            // SynchronizationContext-reliant code before AppMain is called: things aren't initialized
            // yet and stuff might break.
            App.BuildAvaloniaApp()
               .StartWithClassicDesktopLifetime([.. args]);
        }

        static void SetIconData()
        {
            //No license
            IconData.CPU     = "M167.314,14.993C167.314,6.712,160.602,0,152.332,0h-5.514c-8.27,0-14.982,6.712-14.982,14.993v41.466h35.478 V14.993z M238.26,14.993C238.26,6.712,231.549,0,223.278,0h-5.504c-8.271,0-14.982,6.712-14.982,14.993v41.466h35.468 V14.993z M309.207,14.993C309.207,6.712,302.496,0,294.225,0h-5.504c-8.271,0-14.982,6.712-14.982,14.993v41.466h35.468 V14.993z M380.164,14.993C380.164,6.712,373.453,0,365.182,0h-5.514c-8.27,0-14.982,6.712-14.982,14.993v41.466h35.478 V14.993z M131.836,497.007c0,8.282,6.712,14.993,14.982,14.993h5.514c8.27,0,14.982-6.711,14.982-14.993V455.55h-35.478 V497.007z M202.792,497.007c0,8.282,6.712,14.993,14.982,14.993h5.504c8.27,0,14.982-6.711,14.982-14.993V455.55h-35.468 V497.007z M273.739,497.007c0,8.282,6.712,14.993,14.982,14.993h5.504c8.271,0,14.982-6.711,14.982-14.993V455.55 h-35.468V497.007z M344.686,497.007c0,8.282,6.712,14.993,14.982,14.993h5.514c8.271,0,14.982-6.711,14.982-14.993V455.55 h-35.478V497.007z M497.018,131.836H455.55v35.479h41.468c8.27,0,14.982-6.712,14.982-14.993v-5.493 C512,138.548,505.288,131.836,497.018,131.836z M497.018,202.793H455.55v35.468h41.468c8.27,0,14.982-6.712,14.982-14.982v-5.494 C512,209.504,505.288,202.793,497.018,202.793z M497.018,273.739H455.55v35.468h41.468c8.27,0,14.982-6.711,14.982-14.992v-5.494 C512,280.451,505.288,273.739,497.018,273.739z M497.018,344.686H455.55v35.479h41.468c8.27,0,14.982-6.712,14.982-14.993v-5.493 C512,351.398,505.288,344.686,497.018,344.686z M0,146.828v5.493c0,8.281,6.711,14.993,14.982,14.993H56.46v-35.479H14.982C6.711,131.836,0,138.548,0,146.828 z M0,217.785v5.494c0,8.27,6.711,14.982,14.982,14.982H56.46v-35.468H14.982C6.711,202.793,0,209.504,0,217.785z  M0,288.721v5.494c0,8.281,6.711,14.992,14.982,14.992H56.46v-35.468H14.982C6.711,273.739,0,280.451,0,288.721 z M0,359.679v5.493c0,8.281,6.711,14.993,14.982,14.993H56.46v-35.479H14.982C6.711,344.686,0,351.398,0,359.679 z M78.628,433.382h354.753V78.628H78.628V433.382z M376.56,120.2c9.18,0,16.635,7.445,16.635,16.634 c0,9.18-7.455,16.624-16.635,16.624c-9.179,0-16.624-7.445-16.624-16.624C359.936,127.644,367.381,120.2,376.56,120.2z M376.56,361.32c9.18,0,16.635,7.445,16.635,16.635c0,9.179-7.455,16.623-16.635,16.623c-9.179,0-16.624-7.444-16.624-16.623 C359.936,368.764,367.381,361.32,376.56,361.32z M184.362,184.362h143.287v143.287H184.362V184.362z M135.439,120.2 c9.19,0,16.635,7.445,16.635,16.634c0,9.169-7.445,16.624-16.635,16.624c-9.178,0-16.623-7.455-16.623-16.624 C118.816,127.644,126.26,120.2,135.439,120.2z M135.439,361.32c9.19,0,16.635,7.445,16.635,16.635 c0,9.169-7.445,16.623-16.635,16.623c-9.178,0-16.623-7.454-16.623-16.623C118.816,368.764,126.26,361.32,135.439,361.32z";
            
            //No license
            IconData.RAM     = "M 251.0116 416.9356 c -11.4558 0.0021 -20.7366 -9.29 -20.7401 -20.7401 c 0.0042 -11.458 9.285 -20.7387 20.7437 -20.7437 l -0.0035 -38.613 c -11.4537 -0.0014 -20.7366 -9.29 -20.7401 -20.7401 c 0.0014 -11.4608 9.2822 -20.7416 20.7409 -20.7409 L 251.0031 251.0173 L -251.0109 251.0109 l 0.0028 44.3413 c 11.4509 0.0042 20.7366 9.29 20.7401 20.7401 c 0.0007 11.453 -9.285 20.7387 -20.7409 20.7409 l 0.0007 38.6158 c 11.4502 0.0035 20.7366 9.29 20.7401 20.7401 c 0.0007 11.453 -9.2907 20.7444 -20.7409 20.7409 l 0.0021 56.128 L 251.0102 473.0672 L 251.0116 416.9356 z M 185.0407 384.6527 c 2.3221 0.0014 4.2108 1.8901 4.2122 4.2122 l -0.0028 1.5387 c -0.0035 2.3271 -1.8873 4.2108 -4.2094 4.2094 l -11.6482 0.0078 l 0.0057 -9.966 L 185.0407 384.6527 z M 185.0435 364.7292 c 2.3299 -0.0064 4.2073 1.871 4.2073 4.196 l -0.0007 1.5578 c 0.0014 2.3207 -1.8823 4.2045 -4.2066 4.2066 l -11.6559 -0.0057 l 0 -9.9603 L 185.0435 364.7292 z M 189.2508 349.0046 l 0 1.5358 c 0.0028 2.3221 -1.8866 4.2115 -4.2122 4.2122 l -11.6538 0.0078 l 0.012 -9.9709 l 11.6397 0.0007 C 187.3607 344.7895 189.2494 346.6782 189.2508 349.0046 z M 185.0414 324.8632 c 2.3257 -0.0007 4.2144 1.888 4.2122 4.2122 l -0.0057 1.5415 c 0.0021 2.3228 -1.8866 4.2115 -4.2122 4.2122 l -11.6503 -0.0113 l 0 -9.9603 L 185.0414 324.8632 z M 185.0364 304.9264 c 2.325 0 4.2129 1.888 4.2129 4.2129 l 0.0042 1.5514 c 0.0028 2.3221 -1.8809 4.2059 -4.2066 4.2066 l -11.6616 0 l 0.0064 -9.9653 L 185.0364 304.9264 z M 167.1586 289.9774 l 0.0035 119.588 l -64.0186 -0.0028 l -0.0007 -119.5852 L 167.1586 289.9774 z M 49.8772 364.7193 c 2.325 0 4.2136 1.8887 4.2122 4.2122 l 0.0042 1.5514 c -0.0106 2.3144 -1.8915 4.1953 -4.2172 4.196 l -11.6453 0.0049 l 0.0057 -9.966 L 49.8772 364.7193 z M 38.2368 354.759 l -0.0092 -9.9695 l 11.6559 0.0057 c 2.325 -0.0014 4.203 1.8767 4.208 4.1967 l -0.0014 1.557 c -0.0007 2.3257 -1.8866 4.2115 -4.2066 4.2066 L 38.2368 354.759 z M 85.2785 324.8576 l 11.6404 0.0014 l 0.0106 9.9709 l -11.6503 -0.0113 c -2.3299 0.0064 -4.2186 -1.8823 -4.2129 -4.2129 l 0 -1.5358 C 81.067 326.7456 82.9535 324.859 85.2785 324.8576 z M 49.8885 384.6512 c 2.3193 0.0042 4.1974 1.8823 4.2016 4.2016 l -0.0014 1.557 c -0.0007 2.3243 -1.8823 4.2059 -4.2066 4.2066 l -11.6567 -0.0064 l 0.0007 -9.9596 L 49.8885 384.6512 z M 85.2778 354.7604 c -2.325 0 -4.2136 -1.8887 -4.2122 -4.2122 l 0.0007 -1.5578 c -0.0042 -2.3193 1.8767 -4.2002 4.2172 -4.196 l 11.6453 -0.0049 l -0.0057 9.966 L 85.2778 354.7604 z M 85.2778 364.7207 l 11.6404 0.0014 l -0.0007 9.9596 l -11.6404 -0.0014 c -2.3257 0.0007 -4.2165 -1.8844 -4.2073 -4.196 l -0.0042 -1.5514 C 81.067 366.608 82.9535 364.7214 85.2778 364.7207 z M 85.2827 384.6562 l 11.646 -0.0042 l -0.0057 9.966 l -11.646 0.0042 c -2.3214 -0.0007 -4.2108 -1.8901 -4.2122 -4.2122 l 0.0014 -1.557 C 81.0606 386.5336 82.95 384.6442 85.2827 384.6562 z M 85.2834 304.932 l 11.6453 -0.0049 l -0.0113 9.9716 l -11.6397 -0.0007 c -2.325 0 -4.2122 -1.8873 -4.2129 -4.2129 l -0.0014 -1.5542 C 81.062 306.8087 82.9429 304.9278 85.2834 304.932 z M 54.0915 329.0698 l -0.0007 1.5351 c -0.0064 2.3299 -1.888 4.2115 -4.2122 4.2122 l -11.6453 0.0049 l -0.0028 -9.9575 l 11.6489 -0.0071 C 52.2 324.859 54.0887 326.7477 54.0915 329.0698 z M 49.8836 304.9313 c 2.3221 0.0014 4.2009 1.8802 4.2073 4.196 l 0 1.557 c -0.0007 2.3257 -1.8873 4.2122 -4.2122 4.2122 l -11.6397 -0.0007 l -0.0134 -9.9681 L 49.8836 304.9313 z M 32.0001 289.9866 l 0.0064 119.5795 l -64.013 -0.0028 l -0.0035 -119.5824 L 32.0001 289.9866 z M -85.2693 364.7179 c 2.3165 0.0071 4.1953 1.8859 4.2016 4.2016 l -0.0007 1.5578 c -0.0014 2.325 -1.8851 4.2087 -4.2122 4.2122 l -11.6503 -0.0113 l -0.0021 -9.9568 L -85.2693 364.7179 z M -96.9288 354.7555 l 0 -9.9603 l 11.6482 -0.0078 c 2.3221 0.0014 4.2108 1.8901 4.2122 4.2122 l -0.0028 1.5387 c -0.0035 2.3271 -1.8873 4.2108 -4.2122 4.2122 L -96.9288 354.7555 z M -49.88 324.8682 l 11.6453 -0.0049 l 0.0007 9.961 l -11.6496 0.0064 c -2.3207 -0.0014 -4.2094 -1.8901 -4.2115 -4.2115 l -0.0042 -1.5514 C -54.0993 326.7413 -52.2099 324.8519 -49.88 324.8682 z M -85.2806 384.6498 c 2.3221 0.0028 4.2101 1.8908 4.2129 4.2129 l 0 1.5358 c 0.0042 2.3405 -1.8901 4.2136 -4.2122 4.2122 l -11.646 0.0042 l 0.0028 -9.9631 L -85.2806 384.6498 z M -49.88 354.7477 c -2.3299 0.0064 -4.2186 -1.8823 -4.2129 -4.2129 l -0.0028 -1.533 c 0.0014 -2.325 1.8901 -4.2136 4.2151 -4.2151 l 11.6397 0.0007 l 0 9.9603 L -49.88 354.7477 z M -49.885 364.7144 l 11.6559 0.0057 l -0.0057 9.966 l -11.6453 0.0049 c -2.325 0 -4.2129 -1.888 -4.2129 -4.2129 l -0.0014 -1.5542 C -54.0965 366.6023 -52.2099 364.7158 -49.885 364.7144 z M -49.8807 384.6505 l 11.6397 0.0007 l 0 9.9603 l -11.6404 0 c -2.325 0 -4.2087 -1.8724 -4.2129 -4.2129 l 0 -1.5358 C -54.0923 386.5371 -52.2064 384.6512 -49.8807 384.6505 z M -49.8821 304.9285 l 11.6432 -0.0014 l 0.0099 9.9702 l -11.6588 -0.0028 c -2.3228 -0.0021 -4.2108 -1.8901 -4.2023 -4.2023 l -0.0042 -1.5514 C -54.093 306.8158 -52.2036 304.9264 -49.8821 304.9285 z M -81.0754 329.0663 l 0.0071 1.5486 c -0.0007 2.3243 -1.8844 4.208 -4.2151 4.2151 l -11.6404 -0.0014 l -0.0106 -9.9709 l 11.6567 0.0064 C -82.9521 324.8632 -81.0747 326.7406 -81.0754 329.0663 z M -85.282 304.9278 c 2.325 -0.0014 4.2136 1.8873 4.2122 4.2122 l 0.0078 1.5493 c -0.0014 2.325 -1.8851 4.2087 -4.2151 4.2151 l -11.6567 -0.0064 l 0.0099 -9.9716 L -85.282 304.9278 z M -103.1577 289.9753 l -0.0014 119.5873 l -64.0158 0 l 0.0092 -119.5753 L -103.1577 289.9753 z M -189.2529 310.6857 l -0.0042 -1.5514 c 0.0035 -2.3271 1.8922 -4.196 4.2165 -4.1967 l 11.6468 -0.0035 l -0.0057 9.966 l -11.6404 -0.0014 C -187.3656 314.8994 -189.2543 313.0107 -189.2529 310.6857 z M -189.2585 330.612 l 0.0057 -1.5415 c 0 -2.325 1.8866 -4.2115 4.2122 -4.2122 l 11.6404 0 l 0 9.9603 l -11.6453 0.0049 C -187.3677 334.8221 -189.2465 332.9433 -189.2585 330.612 z M -185.0407 354.7604 c -2.3221 -0.0014 -4.2108 -1.8901 -4.2129 -4.2129 l 0.0014 -1.557 c -0.0049 -2.32 1.876 -4.2009 4.2066 -4.2066 l 11.6559 0.0057 l -0.0092 9.9681 L -185.0407 354.7604 z M -189.2593 370.4737 l 0.0064 -1.5408 c 0.0007 -2.3243 1.8901 -4.2136 4.2122 -4.2122 l 11.6397 0.0007 l 0 9.9603 l -11.6397 -0.0007 C -187.3628 374.6796 -189.2571 372.7966 -189.2593 370.4737 z M -189.2515 390.4078 l -0.0021 -1.5549 c -0.0035 -2.3186 1.8859 -4.208 4.2037 -4.2037 l 11.6595 0.0035 l -0.0028 9.9631 l -11.6453 0.0049 C -187.3741 394.6101 -189.2522 392.7321 -189.2515 390.4078 z M -214.4499 456.7132 l 0.0021 -27.8904 l 12.6622 -0.0049 l 0.0014 27.8869 L -214.4499 456.7132 z M -182.4314 456.7125 l 0.0014 -27.8897 l 12.6622 -0.0049 l -0.0021 27.8904 L -182.4314 456.7125 z M -150.4179 456.7196 l 0.0007 -27.8904 l 12.6678 -0.0106 l -0.0014 27.8911 L -150.4179 456.7196 z M -118.4008 456.7174 l -0.0007 -27.8876 l 12.6714 -0.0127 l -0.0014 27.8897 L -118.4008 456.7174 z M -86.3816 456.7174 l 0.0021 -27.8904 l 12.665 -0.0078 l 0.0007 27.8876 L -86.3816 456.7174 z M -54.3631 456.7181 l 0.0007 -27.8904 l 12.665 -0.0078 l 0.0014 27.8883 L -54.3631 456.7181 z M -22.3446 456.7174 l -0.0007 -27.8876 l 12.6685 -0.0099 l 0.0007 27.8876 L -22.3446 456.7174 z M 9.6739 456.7167 l -0.0007 -27.8876 l 12.6678 -0.0106 l 0.0007 27.8876 L 9.6739 456.7167 z M 41.6924 456.7174 l -0.012 -27.8989 l 12.6784 0 l 0.0014 27.8883 L 41.6924 456.7174 z M 73.7109 456.7167 l -0.0113 -27.8982 l 12.6791 0.0007 l 0.0035 27.8904 L 73.7109 456.7167 z M 105.7316 456.7196 l -0.0134 -27.9003 l 12.6805 0.0021 l 0.0014 27.8883 L 105.7316 456.7196 z M 137.7373 456.7118 l 0.0014 -27.8911 l 12.6784 0 l -0.0049 27.8932 L 137.7373 456.7118 z M 169.7551 456.7104 l 0.0014 -27.8897 l 12.6791 0.0007 l 0.0014 27.8869 L 169.7551 456.7104 z M 201.775 428.82 l 12.6784 0 l -0.0014 27.8911 l -12.6791 -0.0007 L 201.775 428.82 z";

            //No license
            IconData.GPU     = "M29.861 22.931v-19.192h-27.723v19.192h13.328v4.265h-3.732v1.066h8.53v-1.066h-3.732v-4.265h13.328zM3.205 4.804h25.59v17.060h-25.59v-17.060z";

            //No license
            IconData.Drives  = "m 28.9376 31.0412 c -2.1639 0 -3.5445 1.7728 -3.9063 3.9063 l -7.8125 38.4067 c -0.2438 2.1502 1.7423 3.9063 3.9063 3.9063 l 85.75 0 c 2.1639 0 4.1489 -1.7559 3.9063 -3.9063 l -7.8125 -38.4067 c -0.3335 -2.1381 -1.7423 -3.9063 -3.9063 -3.9063 z m -7.8125 50.1675 c -2.164 0 -3.9063 1.7423 -3.9063 3.9063 l 0 7.9375 c 0 2.164 1.7423 3.9063 3.9063 3.9063 l 85.75 0 c 2.164 0 3.9063 -1.7423 3.9063 -3.9063 l 0 -7.9375 c 0 -2.164 -1.7423 -3.9063 -3.9063 -3.9063 z m 39.8125 4.7188 l 9.5625 0 c 0.7222 0 1.3125 0.559 1.3125 1.2813 l 0 3.7188 c 0 0.7222 -0.5903 1.3125 -1.3125 1.3125 l -9.5625 0 c -0.7222 0 -1.3125 -0.5903 -1.3125 -1.3125 l 0 -3.7188 c 0 -0.7222 0.5903 -1.2813 1.3125 -1.2813 z m 16.8125 0 l 9.5625 0 c 0.7222 0 1.3125 0.559 1.3125 1.2813 l 0 3.7188 c 0 0.7222 -0.5903 1.3125 -1.3125 1.3125 l -9.5625 0 c -0.7222 0 -1.3125 -0.5903 -1.3125 -1.3125 l 0 -3.7188 c 0 -0.7222 0.5903 -1.2813 1.3125 -1.2813 z m 16.8125 0 l 9.5625 0 c 0.7222 0 1.3125 0.559 1.3125 1.2813 l 0 3.7188 c 0 0.7222 -0.5903 1.3125 -1.3125 1.3125 l -9.5625 0 c -0.7222 0 -1.3125 -0.5903 -1.3125 -1.3125 l 0 -3.7188 c 0 -0.7222 0.5903 -1.2813 1.3125 -1.2813 z";

            //No license
            IconData.Network = "M287.551,470.781a3.113,3.113,0,0,0-2.293,5.231l-5.192,4.675a5.013,5.013,0,0,0-6.364-.033l-4.171-4.177a2.655,2.655,0,0,0,.395-1.383,2.688,2.688,0,1,0-2.687,2.687,2.66,2.66,0,0,0,1.622-.559l4.12,4.127a5.081,5.081,0,0,0-1.242,3.307c0,.115.026.222.034.335l-5.565.721a2.55,2.55,0,1,0,.241,1.069c0-.031-.008-.059-.009-.09l5.494-.712A5.086,5.086,0,0,0,273,487.987l-3.733,4a2.776,2.776,0,0,0-1.4-.39,2.813,2.813,0,1,0,2.812,2.812,2.783,2.783,0,0,0-.647-1.772l3.7-3.956a4.977,4.977,0,0,0,5.543.476l2.972,2.934a3,3,0,1,0,.789-.625l-2.915-2.878a5.037,5.037,0,0,0,.666-7.195l5.281-4.754a3.086,3.086,0,0,0,1.49.4,3.125,3.125,0,0,0,0-6.25Zm-23.665,17.563a1.563,1.563,0,1,1,1.563-1.563A1.564,1.564,0,0,1,263.886,488.344Zm22.478,5.687a1.938,1.938,0,1,1-1.938-1.937A1.94,1.94,0,0,1,286.364,494.031Zm-19.125-17.25a1.688,1.688,0,1,1,1.687-1.687A1.689,1.689,0,0,1,267.239,476.781Zm.625,19.438a1.813,1.813,0,1,1,1.812-1.813A1.815,1.815,0,0,1,267.864,496.219Zm5.875-11.563a3.125,3.125,0,1,1,3.125,3.125A3.129,3.129,0,0,1,273.739,484.656Zm13.812-8.625a2.125,2.125,0,1,1,2.125-2.125A2.127,2.127,0,0,1,287.551,476.031Z";

            //No license
            IconData.Fan     = "M11.56,0h99.75c3.18,0,6.07,1.3,8.17,3.4c2.1,2.1,3.4,4.99,3.4,8.17v99.75c0,3.18-1.3,6.07-3.4,8.17 c-2.09,2.09-4.99,3.4-8.17,3.4H11.56c-3.18,0-6.07-1.3-8.17-3.4C1.3,117.39,0,114.5,0,111.32V11.56C0,8.38,1.3,5.49,3.4,3.4 C5.49,1.3,8.38,0,11.56,0L11.56,0z M57.23,72.48c-1.52-0.48-2.91-1.24-4.19-2.3c-1.36-1.13-2.58-2.57-3.66-4.36 c-0.5,0.03-0.97,0.04-1.43,0.04c-0.8,0.01-1.63-0.03-2.5-0.09c-3.42-0.25-6-1.19-8.57-2.12c-1.67-0.61-3.34-1.21-5.15-1.58 c-0.65-0.13-1.23-0.14-1.74-0.08c-0.87,0.13-1.55,0.56-2.06,1.19c-0.58,0.7-0.97,1.66-1.18,2.7c-0.23,1.15-0.25,2.41-0.07,3.59 c0.16,1.05,0.46,2.12,0.84,3.16c0.39,1.08,0.87,2.12,1.38,3.09c0.46,0.9,0.98,1.75,1.55,2.56c0.57,0.82,1.2,1.61,1.86,2.36 c2.23,2.54,4.54,4.26,6.82,5.21c2.08,0.87,4.15,1.08,6.12,0.72c1.99-0.37,3.9-1.35,5.65-2.89c2.25-1.97,4.22-4.84,5.75-8.54 c0.26-0.62,0.41-1.25,0.49-1.89C57.21,73.02,57.23,72.75,57.23,72.48L57.23,72.48L57.23,72.48z M73.98,65.82 c-0.6,1.47-1.48,2.79-2.65,3.98c-1.24,1.26-2.78,2.35-4.66,3.27c-0.02,0.5-0.04,0.97-0.09,1.43c-0.06,0.8-0.16,1.63-0.3,2.48 c-0.54,3.38-1.69,5.88-2.84,8.36c-0.75,1.62-1.49,3.22-2.01,4.99c-0.19,0.64-0.25,1.21-0.22,1.73c0.06,0.88,0.43,1.59,1.01,2.15 c0.65,0.64,1.57,1.11,2.59,1.41c1.13,0.33,2.38,0.46,3.57,0.38c1.06-0.07,2.15-0.28,3.22-0.57c1.11-0.3,2.18-0.69,3.2-1.12 c0.94-0.39,1.83-0.83,2.68-1.33c0.87-0.5,1.7-1.06,2.51-1.65c2.72-2,4.62-4.16,5.77-6.35c1.04-2,1.44-4.05,1.24-6.04 c-0.2-2.01-1.02-4-2.4-5.88c-1.77-2.41-4.47-4.62-8.02-6.45c-0.59-0.31-1.21-0.52-1.84-0.64C74.51,65.89,74.25,65.85,73.98,65.82 L73.98,65.82L73.98,65.82z M65.86,50.31c1.49,0.54,2.85,1.36,4.09,2.47c1.32,1.19,2.48,2.68,3.48,4.51c0.47,0,0.95,0.01,1.43,0.03 c0.86,0.03,1.68,0.09,2.49,0.18c3.38,0.39,5.93,1.43,8.47,2.48c1.63,0.66,3.25,1.33,5.09,1.78c0.02,0.01,0.03,0.01,0.06,0.02 c0.62,0.15,1.18,0.18,1.67,0.13c0.88-0.09,1.57-0.5,2.11-1.1c0.6-0.68,1.03-1.62,1.29-2.66c0.28-1.14,0.34-2.4,0.22-3.58 c-0.11-1.07-0.37-2.14-0.7-3.2c-0.35-1.09-0.78-2.15-1.26-3.15c-0.43-0.91-0.92-1.79-1.45-2.62c-0.53-0.82-1.12-1.63-1.76-2.43 c-2.12-2.63-4.36-4.43-6.6-5.47c-2.04-0.94-4.11-1.25-6.09-0.97c-2,0.29-3.95,1.19-5.77,2.65c-2.33,1.87-4.42,4.67-6.09,8.29 c-0.28,0.61-0.46,1.24-0.57,1.87C65.91,49.78,65.88,50.04,65.86,50.31L65.86,50.31L65.86,50.31z M68.08,55.6 c-1.54-1.54-3.67-2.49-6.02-2.49c-2.35,0-4.48,0.95-6.02,2.49c-1.54,1.54-2.49,3.67-2.49,6.02s0.95,4.48,2.49,6.01 c1.54,1.54,3.67,2.49,6.02,2.49c2.35,0,4.48-0.96,6.02-2.49c1.54-1.54,2.49-3.67,2.49-6.01S69.61,57.13,68.08,55.6L68.08,55.6 L68.08,55.6z M50.36,57.33c0.53-1.5,1.35-2.86,2.45-4.1c1.17-1.31,2.67-2.47,4.5-3.48c0-0.48,0-0.95,0.02-1.43 c0.03-0.85,0.09-1.68,0.18-2.49c0.38-3.4,1.42-5.95,2.45-8.48c0.67-1.65,1.34-3.3,1.78-5.09c0.16-0.64,0.2-1.22,0.14-1.73 c-0.09-0.87-0.51-1.57-1.11-2.11c-0.69-0.61-1.62-1.03-2.66-1.28c-1.14-0.27-2.4-0.34-3.58-0.21c-1.07,0.12-2.15,0.37-3.2,0.71 c-1.07,0.34-2.13,0.78-3.15,1.26c-0.91,0.43-1.78,0.92-2.62,1.46c-0.85,0.55-1.66,1.13-2.42,1.76c-2.63,2.13-4.43,4.37-5.47,6.63 c-0.94,2.04-1.25,4.11-0.95,6.08c0.29,2,1.19,3.95,2.66,5.76c1.88,2.32,4.68,4.41,8.31,6.08c0.61,0.28,1.24,0.46,1.86,0.56 C49.82,57.28,50.09,57.31,50.36,57.33L50.36,57.33L50.36,57.33z M61.44,15.39c25.44,0,46.06,20.62,46.06,46.06 c0,25.44-20.62,46.06-46.06,46.06c-25.44,0-46.06-20.62-46.06-46.06C15.38,36.01,36,15.39,61.44,15.39L61.44,15.39z M108.06,9.56 c3.23,0,5.84,2.62,5.84,5.84c0,3.23-2.62,5.84-5.84,5.84c-3.22,0-5.84-2.62-5.84-5.84C102.22,12.17,104.84,9.56,108.06,9.56 L108.06,9.56z M14.81,9.56c3.23,0,5.84,2.62,5.84,5.84c0,3.23-2.62,5.84-5.84,5.84c-3.23,0-5.84-2.62-5.84-5.84 C8.97,12.17,11.59,9.56,14.81,9.56L14.81,9.56z M108.06,101.73c3.23,0,5.84,2.62,5.84,5.84s-2.62,5.84-5.84,5.84 c-3.22,0-5.84-2.62-5.84-5.84S104.84,101.73,108.06,101.73L108.06,101.73z M20.66,107.57c0,3.23-2.62,5.84-5.84,5.84 c-3.23,0-5.84-2.62-5.84-5.84s2.62-5.84,5.84-5.84C18.04,101.73,20.66,104.35,20.66,107.57L20.66,107.57z";
        }

        static void OnUnhandledExceptionAppDomain(object sender, UnhandledExceptionEventArgs e)
        {
            if (e.ExceptionObject is Exception ex)
            {
                Logger.Instance.Add(LogLevel.Fatal, ex.FullExceptionString(), DateTime.Now);
            }
            else
            {
                Logger.Instance.Add(LogLevel.Fatal, $"{(e.IsTerminating ? "Fatal error: " : "Error: ")} The application will terminate now.", DateTime.Now);
            }

            LoggerUtilities.SaveLogFile();

            if (e.IsTerminating)
            {
                Environment.Exit(1);
            }
        }

        #endregion
    }
}
